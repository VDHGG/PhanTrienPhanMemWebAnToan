<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title><%= product.name %></title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    /* Cải thiện layout: Tăng kích thước ảnh, giảm khoảng trống */
    .hero {
      display: flex;
      align-items: flex-start;
      justify-content: space-between; /* Phân bổ không gian đều hơn */
      gap: 20px; /* Giảm gap để lấp khoảng trống */
      margin: 20px auto; /* Giảm margin top/bottom */
      padding: 20px;
      border-radius: 16px;
      background: linear-gradient(90deg, rgba(255,107,53,0.08), rgba(0,212,255,0.03));
    }
    .hero-left {
      width: 60%; /* Tăng width ảnh lên 60% để lớn hơn */
      max-width: 600px; /* Giới hạn max để không quá to trên màn lớn */
    }
    .hero-right {
      width: 40%; /* Giảm width info để cân bằng */
      padding: 10px; /* Thêm padding nhẹ để info sát hơn */
    }
    .hero-img {
      width: 100%;
      height: auto;
      border-radius: 12px;
      box-shadow: 0 10px 20px rgba(2,6,23,0.4); /* Thêm shadow để ảnh nổi bật */
      object-fit: cover; /* Đảm bảo ảnh lấp đầy mà không méo */
    }
    /* Các style cũ giữ nguyên, chỉ override cần thiết */
    .product-name { font-size: 28px; margin-bottom: 10px; }
    .info-line { font-size: 16px; color: gray; margin-bottom: 20px; }
    .price { font-size: 32px; color: red; font-weight: bold; }
    .original-price { text-decoration: line-through; color: gray; font-size: 24px; margin-left: 10px; }
    .discount { color: green; font-size: 24px; margin-left: 10px; }
    .stock-message { margin: 10px 0; }
    .provider { margin: 10px 0; }
    .select-group { display: flex; gap: 20px; margin: 20px 0; }
    .select-group label { font-weight: bold; }
    .select-group select { padding: 10px; border: 1px solid #ccc; border-radius: 5px; width: 200px; }
    .buttons { display: flex; gap: 20px; margin-top: 30px; }
    .buttons button { padding: 15px 30px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
    .favorite-btn { background-color: pink; color: white; }
    .cart-btn { background-color: lightblue; color: white; }
  </style>
</head>
<body>
  <%- include('partials/header') %>

  <div class="site-wrapper">
    <div class="hero">
      <div class="hero-left">
        <div class="thumb">
          <img class="hero-img" src="/<%= product.image %>" alt="<%= product.name %>">
        </div>
      </div>
      <div class="hero-right">
        <div class="eyebrow">Sản phẩm</div>
        <h1><%= product.name %></h1>
        <p class="text-muted"><%= (parseFloat(product.avg_rating) || 0).toFixed(1) %> ⭐ (<%= reviews.length %> đánh giá) | Mã: <%= product.product_id %></p>
        <%
          // Tính giá sau giảm từ DB: price_after = price * (1 - discount/100)
          const price_after = product.price * (1 - (product.discount || 0) / 100);
        %>
        <div style="margin:12px 0">
          <span class="price"><%= price_after.toLocaleString('vi-VN') %> đ</span>
          <span class="old-price"><%= product.price.toLocaleString('vi-VN') %> đ</span>
        </div>
        <p class="text-muted">NEM còn <%= product.stock %> chiếc • Nhà cung cấp: <%= product.provider || 'Chưa có' %></p>

        <div style="margin-top:14px;display:flex;gap:12px">
          <div style="flex:1">
            <label style="font-weight:700;color:var(--muted);">Chọn size</label>
            <br>
            <select id="sizeSelect" style="padding:8px;border-radius:8px;margin-top:8px;width:100%">
              <% (product.sizes || '').split(',').forEach(size => { %>
                <option><%= size.trim() %></option>
              <% }) %>
            </select>
          </div>
          <div style="flex:1">
            <label style="font-weight:700;color:var(--muted);">Chọn màu</label>
            <br>
            <select id="colorSelect" style="padding:8px;border-radius:8px;margin-top:8px;width:100%">
              <% (product.colors || '').split(',').forEach(color => { %>
                <option><%= color.trim() %></option>
              <% }) %>
            </select>
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap">
          <div style="display:flex;align-items:center;gap:8px">
            <label style="font-weight:700;color:var(--muted);font-size:14px">Số lượng</label>
            <div style="display:flex;align-items:center;border:1px solid rgba(255,255,255,0.1);border-radius:6px;overflow:hidden">
              <button type="button" onclick="decQty()" style="background:transparent;border:none;color:var(--white);padding:8px 10px;cursor:pointer;font-weight:700">−</button>
              <input type="number" id="quantityInput" name="quantity" value="1" min="1" max="<%= product.stock %>" style="width:50px;text-align:center;border:none;background:transparent;color:var(--white);font-weight:700" readonly>
              <button type="button" onclick="incQty()" style="background:transparent;border:none;color:var(--white);padding:8px 10px;cursor:pointer;font-weight:700">+</button>
            </div>
          </div>
        </div>

        <div style="margin-top:12px;display:flex;gap:10px">
          <form action="/wishlist/add/<%= product.product_id %>" method="GET" style="margin:0">
            <button class="btn-ghost" type="submit">❤️ Yêu thích</button>
          </form>
          <form action="/cart/add" method="POST" style="margin:0;flex:1">
            <input type="hidden" name="id" value="<%= product.product_id %>">
            <input type="hidden" name="price" value="<%= product.price %>">
            <input type="hidden" id="sizeInput" name="size" value="">
            <input type="hidden" id="colorInput" name="color" value="">
            <input type="hidden" id="quantityHiddenInput" name="quantity" value="1">
            <button class="btn-primary" type="submit" style="width:100%">Thêm vào giỏ hàng</button>
          </form>
        </div>

        <script>
          function incQty() {
            let inp = document.getElementById('quantityInput');
            let max = parseInt(inp.max) || 999;
            let val = parseInt(inp.value) || 1;
            if (val < max) inp.value = val + 1;
            document.getElementById('quantityHiddenInput').value = inp.value;
          }
          function decQty() {
            let inp = document.getElementById('quantityInput');
            let val = parseInt(inp.value) || 1;
            if (val > 1) inp.value = val - 1;
            document.getElementById('quantityHiddenInput').value = inp.value;
          }
          // Sync size & color on cart form submit
          (function() {
            const cartForm = document.querySelector('form[action="/cart/add"]');
            if (!cartForm) return;
            cartForm.addEventListener('submit', function() {
              const sizeSelect = document.getElementById('sizeSelect');
              const colorSelect = document.getElementById('colorSelect');
              document.getElementById('sizeInput').value = sizeSelect ? sizeSelect.value : '';
              document.getElementById('colorInput').value = colorSelect ? colorSelect.value : '';
              document.getElementById('quantityHiddenInput').value = document.getElementById('quantityInput').value;
            });
          })();
        </script>
      </div>
    </div>

    <section style="margin-top:24px">
      <h3>Mô tả sản phẩm</h3>
      <p style="color:var(--muted)"><%= product.description %></p>
    </section>

    <% if (eligible) { %>
      <section style="margin-top:20px">
        <h3>Đánh giá sản phẩm</h3>
        <form action="/products/<%= product.product_id %>/review" method="POST">
          <select name="rating" required style="padding:8px;border-radius:8px">
            <option value="">Chọn sao</option>
            <option value="1">1 ⭐</option>
            <option value="2">2 ⭐</option>
            <option value="3">3 ⭐</option>
            <option value="4">4 ⭐</option>
            <option value="5">5 ⭐</option>
          </select>
          <br>
          <textarea name="comment" placeholder="Nhận xét của bạn..." required style="width:100%;min-height:80px;margin-top:8px;padding:8px;border-radius:8px"></textarea>
          <br>
          <button class="btn-primary" type="submit" style="margin-top:8px">Gửi đánh giá</button>
        </form>
      </section>
    <% } %>

    <section style="margin-top:20px">
      <h3>Đánh giá từ khách hàng</h3>
      <% if (reviews.length === 0) { %>
        <p class="text-muted">Chưa có đánh giá.</p>
      <% } else { %>
        <% reviews.forEach(r => { %>
          <div style="background:var(--card);padding:12px;border-radius:10px;margin-bottom:10px">
            <p style="margin:0"><b><%= r.fullname %></b> - <%= r.rating %> ⭐ - <%= r.created_at %></p>
            <p class="text-muted" style="margin:6px 0 0"><%= r.comment %></p>
          </div>
        <% }) %>
      <% } %>
    </section>

    <section style="margin-top:24px">
      <h2>Sản phẩm gợi ý</h2>
      <div class="grid">
        <% if (recommendations && recommendations.length > 0) { %>
          <% recommendations.forEach(rec => { %>
            <%
              // Tính giá sau giảm cho gợi ý
              const rec_price_after = rec.price * (1 - (rec.discount || 0) / 100);
            %>
            <div class="card">
              <div class="thumb"><a href="/products/<%= rec.product_id %>"><img src="/<%= rec.image %>"></a></div>
              <div class="meta">
                <div class="title"><a href="/products/<%= rec.product_id %>" style="color:inherit;text-decoration:none"><%= rec.name %></a></div>
                <div class="price"><%= rec_price_after.toLocaleString('vi-VN') %> đ <span class="old-price"><%= rec.price.toLocaleString('vi-VN') %> đ</span></div>
              </div>
            </div>
          <% }) %>
        <% } else { %>
          <p class="text-muted">Không có gợi ý hiện tại.</p>
        <% } %>
      </div>
    </section>
  </div> <!-- .site-wrapper -->

  <a href="/" style="display:inline-block;margin:18px 20px;color:var(--muted)">← Quay lại</a>
  <%- include('partials/footer') %>
</body>
</html>
