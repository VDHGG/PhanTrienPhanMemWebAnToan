<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Gi·ªè h√†ng c·ªßa b·∫°n</title>
  <link rel="stylesheet" href="/css/style.css">
</head>
<body>
  <%- include('partials/header') %>
  <div style="text-align:center;margin:20px 0">
    <h1 style="margin:0">üõçÔ∏è Gi·ªè h√†ng</h1>
  </div>

  <% if (cart.length === 0) { %>
    <p style="text-align: center;">Gi·ªè h√†ng tr·ªëng!</p>
  <% } else { %>
    <table class="cart-table">
      <thead>
        <tr>
          <th>H√¨nh ·∫£nh</th>
          <th>T√™n s·∫£n ph·∫©m</th>
          <th>Size</th>
          <th>M√†u</th>
          <th>S·ªë l∆∞·ª£ng</th>
          <th>Gi√° (sau gi·∫£m)</th>
          <th>H√†nh ƒë·ªông</th>
        </tr>
      </thead>
      <tbody>
      <% let total = 0; %>
      <% cart.forEach((item, index) => { %>
        <%
          // T√≠nh gi√° sau gi·∫£m cho item
          const item_price_after = item.price * (1 - (item.discount || 0) / 100);
          const item_total_after = item_price_after * item.quantity;
          total += item_total_after;
        %>
        <tr>
          <td><img class="cart-image" src="/<%= item.image %>" alt="<%= item.name %>"></td>
          <td><%= item.name %></td>
          <td><%= item.size ? item.size : '-' %></td>
          <td><%= item.color ? item.color : '-' %></td>
          <td><%= item.quantity %></td>
          <td><%= item_total_after.toLocaleString('vi-VN') %> ƒë <span class="old-price" style="text-decoration:line-through;color:var(--muted);font-size:0.9em">(<%= (item.price * item.quantity).toLocaleString('vi-VN') %> ƒë)</span></td>
          <td>
            <button class="btn-danger" type="button" onclick="openDeleteModal(this)" data-index="<%= index %>" data-name="<%= item.name %>" data-size="<%= item.size || '' %>" data-color="<%= item.color || '' %>">‚ùå X√≥a</button>
          </td>
        </tr>
      <% }) %>

      <tr>
        <td colspan="5"><b>T·ªïng c·ªông</b></td>
        <td colspan="2"><b><%= total.toLocaleString('vi-VN') %> ƒë</b></td>
      </tr>
      <tr>
        <td colspan="7" style="text-align:center;">
          <% if (session && session.user) { %>
            <a href="/checkout">
              <button class="btn-primary">üí≥ Thanh to√°n</button>
            </a>
          <% } else { %>
            <a href="#" onclick="showModal(); return false;">
              <button class="btn-primary">üí≥ Thanh to√°n</button>
            </a>
          <% } %>
        </td>
      </tr>
      </tbody>
    </table>
  <% } %>

  <div style="text-align:center;margin:20px 0">
    <a href="/" class="btn-continue">‚Üê Ti·∫øp t·ª•c mua h√†ng</a>
  </div>

  <!-- Modal th√¥ng b√°o -->
  <div id="loginModal" class="modal">
    <div class="modal-content">
      <p>Qu√Ω Kh√°ch Vui L√≤ng ƒêƒÉng Nh·∫≠p ho·∫∑c ƒêƒÉng K√Ω T√†i Kho·∫£n Tr∆∞·ªõc Khi Thanh To√°n</p>
      <button class="modal-button login-btn" onclick="window.location.href='/login'">ƒêƒÉng Nh·∫≠p</button>
      <button class="modal-button register-btn" onclick="window.location.href='/register'">ƒêƒÉng K√Ω</button>
      <button class="modal-button cancel-btn" onclick="closeModal()">Cancel</button>
    </div>
  </div>

  <!-- Modal x√°c nh·∫≠n x√≥a item -->
  <div id="deleteConfirmModal" class="modal">
    <div class="modal-content">
      <p id="deleteMessage">B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y kh·ªèi gi·ªè h√†ng?</p>
      <button class="modal-button cancel-btn" onclick="closeDeleteModal();">H·ªßy</button>
      <button class="modal-button" id="confirmDeleteBtn" style="background:#d9534f; color:#fff;" onclick="confirmDelete();">X√≥a</button>
    </div>
  </div>

  <script>
    function showModal() {
      document.getElementById('loginModal').style.display = 'block';
    }
    function closeModal() {
      document.getElementById('loginModal').style.display = 'none';
    }
    window.onclick = function(event) {
      let modal = document.getElementById('loginModal');
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    }

    // Delete confirm modal logic
    let pendingDeleteIndex = null;
    function openDeleteModal(btn) {
      const idx = btn.getAttribute('data-index');
      const name = btn.getAttribute('data-name') || '';
      const size = btn.getAttribute('data-size') || '';
      const color = btn.getAttribute('data-color') || '';
      pendingDeleteIndex = idx;
      let msg = `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a "${name}"`;
      if (size) msg += ` - Size: ${size}`;
      if (color) msg += ` - M√†u: ${color}`;
      msg += ' kh·ªèi gi·ªè h√†ng?';
      document.getElementById('deleteMessage').innerText = msg;
      document.getElementById('deleteConfirmModal').style.display = 'block';
    }
    function closeDeleteModal() {
      document.getElementById('deleteConfirmModal').style.display = 'none';
      pendingDeleteIndex = null;
    }
    function confirmDelete() {
      if (pendingDeleteIndex === null) return closeDeleteModal();
      window.location.href = '/cart/remove/' + pendingDeleteIndex;
    }
    window.addEventListener('click', function(event) {
      let modal = document.getElementById('deleteConfirmModal');
      if (event.target == modal) {
        modal.style.display = 'none';
      }
    });
  </script>

  <%- include('partials/footer') %>
</body>
</html>
